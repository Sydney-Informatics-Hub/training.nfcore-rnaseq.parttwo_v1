---
title: "Load count matrix and explore"
teaching: 10
exercises: 10
questions:
- "How to import a count-matrix in R?"
- "How to perform exploratory analysis of the count-matrix?" 


objectives:
- "Load the count matrix in R and perform initial exploratory analysis"

keypoints:
- XXX
---

### The gene-count matrix
- The gene-count matrix is generated in the folder ```results/star_salmon/salmon.merged.gene_counts.tsv```.
- For today's session, we will be using a pre-computed gene-count matrix which was generated by aligning the full set of reads to the complete mouse genome.
- This file was downloaded previously along with the other files from cloudstor and is named as ```GSE81082_count_matrix_ENSIDs_symbols_nr.txt```. It is available in the path ```/PATH/GSE81082_count_matrix_ENSIDs_symbols_nr.txt```


### Working in RStudio

### R-markdown
- R Markdown is a file format for making dynamic documents with R.
- An R Markdown document is written in markdown (an easy-to-write plain text format) and contains chunks of embedded R code, like the document shown below.
  <p align="center">
  <img src="{{ page.root }}/fig/R_markdown.png" style="margin:10px;height:350px"/>
  </p>



### Open a R-markdown file 
  <p align="center">
  <img src="{{ page.root }}/fig/Rmarkdown_open_file.png" style="margin:10px;height:350px"/>
  </p>

- From here on we will be running individual chunks of code in the R-markdown document and follow


#### Load the R libraries
- Many independant libraries (packages) have been developed which assist in differnt aspectes of analysis in the R environment.
- We need to load the individual libraries using a command ```library("PACKAGE_NAME")```.

```{r}
suppressMessages({
   library("DESeq2")
   library("edgeR")
   library("limma")
   library("RColorBrewer")
   library("gplots")
   library("ggplot2")
   library("EnhancedVolcano")
   library("factoextra")
   library("devtools")
   library("rstudioapi")
   library("dplyr")
   library("tibble")
   library("tidyverse")
   library("pheatmap")
   library("biomaRt")
   library("annotables")
   library("org.Mm.eg.db")
   library("biobroom")
   library("clusterProfiler")
   library("pathfindR")
 })

#Set the working directory
current_path <- getActiveDocumentContext()$path 
setwd(dirname(current_path ))
```
 
#### Uploading the count data into R
- We are using the R package **DESeq2** for the identification of differentially expressed genes.
- The DESeq2 package expects count data from RNA-seq or another high-throughput sequencing experiment in the form of a matrix of integer values, as input. 
  - The value in the i-th row and the j-th column of the matrix tells how many reads can be assigned to gene i in sample j. 
  - The values in the matrix should be raw counts, as generated by the STAR aligner from the nfcore-rnaseq pipeline. 
- Next, we read in the count matrix which is similar to the one generated by the "nfcore-rnaseq" pipeline in yesterday's session. If you all remember, we have generated a matrix for a sub-set of the data from a specific region of the genome (chromosome 18). The sub-setting of both, the samples fastq files and the reference database was primarily done for practical purposes so that we can use the limited-sized Nimbus VM training resource.
- Today, we will be using a full gene count-matrix which was downloaded from the original manuscript. The file containing the full matrix should be available in the same folder "/XXX" with the name "GSE81082_count_matrix_ENSIDs_symbols_nr.txt". 

```
counttable_original<-read.delim("GSE81082_count_matrix_ENSIDs_symbols_nr.txt", header=T, row.names=1) 
# View the count matrix
  View(counttable_original)
# Gene symbol as the preferred identifier when compared to Ensembl ID 
  counttable<-counttable_original[,c("Symbol","WT1","WT2","WT3","KO1","KO2","KO3")]
  row.names(counttable) <- NULL
# Convert Column 'GeneSymbol' to rowname
  rownames(counttable) <- counttable$Symbol
  counttable<-counttable[,c("WT1","WT2","WT3","KO1","KO2","KO3")]
  View(counttable)
```

  <p align="center">
  <img src="{{ page.root }}/fig/count_matrix.png" style="margin:10px;height:350px"/>
  </p>


### Exploratory analysis and visualization

#### Box plots
- Let's have a quick look at distribution of the data across sample using box plots
- Box plots can be used to check if one or more samples are consistently higher/different than the others.
```
boxplot(log2((counttable)+1),las=3, col="red")
```

#### What is a DESeq2 object?
- The basic entity used by the DESeq2 package is and object class called DESeqDataSet.
- The DESeqDataSet object is used to store both the read counts and the intermediate estimated quantities during statistical analysis 
- We will call this object by name 'dds' which is a standard practice (**Note** We can name this object absolutely anything in real world :-)).
- Please see the [guide](http://bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html) for detailed information about the DESeq2 library.
- We also define a condition variable to associate the individual columns (samples) in the matrix to their appropriate experimental condition (either 'Wild-type' or 'Knockout').



- We will then prepare the DESeq2 object with `design = ~1`; 
   - A design of ~1 is used for no experimental design and is useful for exploring quality of the data (not for identifying differentially expressed -DE genes).

```{r}
#The condition variable 
condition=c("Wild","Wild","Wild","KO","KO","KO")
meta <- data.frame(row.names=colnames(counttable),condition)
View(meta)
## The DESeqDataSet object (for exploration)
dds <- DESeqDataSetFromMatrix(countData = counttable, 
                              colData = meta, 
                              design = ~1)
```



#### Data transformations
- For visualization or clustering it is useful to work with transformed versions of the count data.
- The two most common choices of transformation used for this purpose are -
   - Variance stabilizing transformation (vst)
   - Regularized log transformation (rlog)
- These algorithms transform the raw count data (which is heteroskedatic - variance grows with the mean) into homoskedatic data (variance is not dependant on the mean). 
- Both methods produce data on the log2 scale, and normalize for other factors such as library size. Setting `blind=TRUE` (the default) should be used to compare samples in a manner wholly unbiased about the information about experimental groups, for example to perform sample QC. 

- **Note** : In order to test for differential expression, we operate on raw counts (and not normalized/transformed counts).


#### Variance stabilisting transformation (VST)
- VST is much faster than rlog, and is recommended if you have hundreds of samples.

```{r}
vst <- vst(dds, blind = TRUE)
vst.data <- assay(vst)

# Regularized log (rlog) takes a long time with 50 or more samples
# rld <- rlog(dds, blind=FALSE)
```


#### Re-drawing the box plots 
- We will now re-generate the box plots to see if the transformation has brought about any difference in distribution.
```{r, fig.width=12}
boxplot(vst.data,las=3, col="red")
```


Challenge
DO you see difference in the two box plotS?


#### Heatmap (Sample-to-sample distances)
- A heatmap of a distance matrix gives us an overview over similarities and dissimilarities between samples. 
- We have to provide a hierarchical clustering hc to the heatmap function based on the sample distances.
```{r}
sampleDists <- dist(t(assay(vst)))
sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- paste(vst$condition, vst$type, sep="-")
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
pheatmap(sampleDistMatrix,
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         col=colors)
```


### Principal Component Analysis (PCA)
- PCA is a linear dimensionality reduction technique. It extracts information from a high-dimensional space by projecting it into a lower-dimensional sub-space. Here dimensions are the features (all your thousands of genes from the genome) which represent the data and explain most of the variability.
- PCA preserves the essential parts that have more variation of the data and remove the non-essential parts with fewer variation.
- This plot is useful for visualizing the overall effect of experimental covariates and batch effects.
- Ideally, in your experiment, the most of the variability is explained by the conditions (e.g. WT versus KO in this case). If any of the samples group differently, the DE analysis cannot be relied upon. 
- If we have big number of replicate samples, PCA allows you to identify and remove (if required) any outliers.

```{r}
plotPCA(vst)
```

<p align="center">
  <img src="{{ page.root }}/fig/PCA.png" style="margin:10px;height:350px"/>
  </p>
  
  
 ### Scree plot
- The Principal Component matrix has the same dimensions as the original data matrix; however, many of the PCs may not be informative. A reduction in the number of PCs is typically required. 
- To do so, it is useful to examine the amount of variance explained by each new PC vector.
- A scree plot is a line plot of the principal components in an analysis. 
  - The scree plot is used to determine the number of principal components to keep in a principal component analysis (PCA).
  - It shows the eigenvalues on the y-axis and the number of factors on the x-axis and it always displays a downward curve.
  - The point where the slope of the curve is clearly leveling off (the â€œelbow) indicates the number of factors that should be generated by the analysis.
  - Let's draw a scree plot.
  
```{r}
pca=prcomp(t(assay(vst)),scale=FALSE)
options(repr.plot.width=0.5, repr.plot.height=0.5)
fviz_eig(pca, addlabels = TRUE)
```

<p align="center">
  <img src="{{ page.root }}/fig/scree_plot.png" style="margin:10px;height:350px"/>
  </p>
  
  
We can see that PC1 followed by PC2 have captured most of the variance.

#### Small contributions of many genes to variation 
It is observed that in biological experiments multiple genes contribute to the the principle compoments in a small way. This can be seen in the plot below where the Y-axis shows the small % contributions of multiple genes to PC1

<p align="center">
  <img src="{{ page.root }}/fig/PCA1_gene_contributions.png" style="margin:10px;height:350px"/>
  </p>
  
